<launch>
  <!-- start basic args -->
  <arg name="veh" value="$(env VEHICLE_NAME)"/>
  <arg name="config" default="baseline" />
  <arg name="param_file_name" default="default" />
  <arg name="visualization" default="true" />
  <arg name="verbose" default="true" />
  <!-- end basic args -->
 
  <!-- start switch args -->
  <arg name="camera" default="true"/>
  <group if="$(arg camera)">
    <arg name="raw" default="true"/>
    <arg name="cam_info" default="true"/>
  </group>
  <arg name="wheels" default="true"/>
  <group if="$(arg wheels)">
  </group>
  <arg name="joystick" default="true"/>
  <arg name="lane_following"/>
  <group if="$(arg lane_following">
    <arg name="line_detection" default="true"/>
    <arg name="white_balance" default="true" />
    <arg name="ground_projection" default="true"/>
    <arg name="lane_filter" default="true"/>
    <arg name="stop_line_filter" default="true"/>
    <arg name="lane_controller" default="true"/>
  </group>
  <arg name="fsm" default="true"/>
  <group if="fsm">
    <arg name="car_cmd_switch" default="true" />
  </group>
  <arg name="learning" default="false"/>
  <group if="$(arg learning)">
  </group>
  <arg name="obstacle_avoidance" default="true"/>
  <group if="obstacle_avoidance">
    <arg name="simple_stop" default="true"/>
    <arg name="object_detection" default="true"/>
    <arg name="object_safety" default="true/>
  </group>
  <arg name="vehicle_avoidance" default="true"/>
  <group if="vehicle_avoidance">
    <arg name="vehicle_detection" default="true" />
    <arg name="vehicle_filter" default="true" />
    <arg name="vehicle_control" default="true"/>
  </group>
  <!-- end switch args -->

  <!-- Start Camera -->  
  <group if="$(arg camera)">
    <include  file="$(find pi_camera)/launch/camera_node.launch">
      <arg name="veh" value="$(arg veh)"/>
      <arg name="config" value="$(arg config)"/>
      <arg name="param_file_name" value="$(arg param_file_name)"/>
    </include>
    <!-- decoder_node -->
    <group if="$(arg raw)">
      <remap from="decoder_node/compressed_image" to="camera_node/image/compressed"/>
      <remap from="decoder_node/image/raw" to="camera_node/image/raw"/>
      <include file="$(find pi_camera)/launch/decoder_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>
  
    <!-- cam_info_reader_node -->
    <group if="$(arg cam_info)">
      <remap from="cam_info_reader_node/camera_info" to="camera_node/camera_info"/>
      <remap from="cam_info_reader_node/compressed_image" to="camera_node/image/compressed"/>
      <include file="$(find pi_camera)/launch/cam_info_reader_node.launch"> 
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>            
      </include>
    </group>
  </group>
  <!-- End Camera -->

  <!-- Start Wheels -->
  <group if="$(arg wheels)">
    <!-- Wheel Driver -->
    <include file="$(find dagu_car)/launch/wheels_driver_node.launch">
      <arg name="veh" value="$(arg veh)"/>
    </include>

    <include file="$(find kinematics)/launch/inverse_kinematics_node.launch">
      <arg name="veh" value="$(arg veh)"/>
    </include>
  </group>
  <!-- End Wheels -->

  <!-- Start FSM -->
  <group if="$(arg fsm)">
    <!-- FSM -->
    <remap from="fsm_node/lane_pose" to="lane_filter_node/lane_pose"/>
    <remap from="fsm_node/stop_line_reading" to="stop_line_filter_node/stop_line_reading"/>
    <remap from="fsm_node/clearance_to_go" to="veh_coordinator_node/clearance_to_go"/>
    <remap from="fsm_node/intersection_done" to="open_loop_intersection_control_node/intersection_done"/>
    <remap from="fsm_node/object_too_close" to="obstacle_safety_node/object_too_close"/>

    <include file="$(find fsm)/launch/fsm_node.launch">
      <arg name="veh" value="$(arg veh)"/>        
      <arg name="config" value="$(arg config)"/>        
      <arg name="param_file_name" value="$(arg param_file_name)"/>        
    </include>

    <!-- car_cmd_switch_node -->
    <remap from="car_cmd_switch_node/cmd_lane_following" to="lane_controller_node/lane_control"/> <!-- need either lots more of these or none of these -->
    <include file="$(find dagu_car)/launch/car_cmd_switch_node.launch">
        <arg name="veh" value="$(arg veh)"/>
        <arg name="local" value="$(arg local)"/>
        <arg name="config" value="$(arg config)"/>
        <arg name="param_file_name" value="$(arg param_file_name)"/>
    </include>
  </group>

  <!--End FSM -->

  <!-- Start Lane Following -->
  <group if="$(arg lane_following)">

    <!-- Line Detector -->
    <group if="$(arg line_detection)">
      <remap from="line_detector_node/image" to="camera_node/image/compressed"/>
      <include file="$(find line_detector)/launch/line_detector_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
        <arg name="white_balance" value="$(arg white_balance)" />
        <arg name="verbose" value="$(arg verbose)" />
      </include>	
    </group>
    
    <!-- Ground projection -->
    <group if="$(arg ground_projection)">
      <include file="$(find ground_projection)/launch/ground_projection.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>
	
    <!-- Lane Filter -->
    <group if="$(lane_filter)">
      <remap from="lane_filter_node/segment_list" to="ground_projection/lineseglist_out"/>
      <include file="$(find lane_filter)/launch/lane_filter_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>

    <!-- Stop Line Filter -->
    <group if="$(arg stop_line_filter)">      <remap from="stop_line_filter_node/lanewidth" to="lane_filter_node/lanewidth"/>
      <remap from="stop_line_filter_node/lane_pose" to="lane_filter_node/lane_pose"/>
      <remap from="stop_line_filter_node/segment_list" to="ground_projection/lineseglist_out"/>
      <include file="$(find stop_line_filter)/launch/stop_line_filter_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>

    <!-- Lane controller -->
    <group if="$(arg lane_controller)">
      <remap from="lane_controller_node/lane_pose" to="lane_filter_node/lane_pose"/>
      <include if="lane_controller" file="$(find lane_control)/launch/lane_controller_node.launch">
        <arg name="veh" value="$(arg veh)"/>
        <arg name="config" value="$(arg config)"/>
        <arg name="param_file_name" value="$(arg param_file_name)"/>        
      </include>
    </group>

  </group>
  <!-- End Lane Control -->

  <!-- Start Obstacle Avoidance -->
  <group if="$(arg obstacle_avoidance)">
    
    <!-- Object Detection -->
    <group if="$(arg object_detector)">
      <remap from="static_object_detector_node/image_compressed" to="camera_node/image/compressed"/>
      <include file="$(find mdoap)/launch/static_object_detector_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>

    <!-- Object Safety -->
    <group if="$(arg object_safety)">
      <remap from="obstacle_safety_node/detection_list" to="static_object_detector_node/detection_list"/>
      <include file="$(find mdoap)/launch/obstacle_safety_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>

    <!-- Simple Stop Controller -->
    <group if="$(arg simple_stop)">
      <remap from="simple_stop_controller_node/too_close" to="obstacle_safety_node/object_too_close"/>
      <include file="$(find mdoap)/launch/simple_stop_controller_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="config" value="$(arg config)"/>
	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>
  </group> 

  <!-- Start Vehicle Avoidance -->
  <group if="$(arg vehicle_avoidance)">

    <!-- Vehicle Detection Node -->
    <group if="$(arg vehicle_detection)">
      <include file="$(find vehicle_detection)/launch/vehicle_detection_node.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)" />
      </include>
    </group>
  
    <!-- Vehicle Filter Node -->
    <group if="$(arg vehicle_filter)">
      <include file="$(find vehicle_detection)/launch/vehicle_filter.launch">
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)" />
      </include>	
    </group>
    <!-- Vehicle Control Node -->
    <group if="$(arg vehicle_control)">
      <include file="$(find vehicle_detection)/launch/vehicle_avoidance_control_node.launch" >
	<arg name="veh" value="$(arg veh)"/>
	<arg name="local" value="$(arg local)" />
      </include>
    </group>
  </group>
  <!-- End Vehicle Avoidance -->
  
  <!-- Start April Tags -->
  <group if="$(arg apriltags)">

    <!-- Preprocessing -->
    <group if="$(arg preprocessing)">
      <include file="$(find apriltags)/launch/apriltags_preprocessing_node.launch">
 	<arg name="veh" value="$(arg veh)"/>
 	<arg name="config" value="$(arg config)"/>
 	<arg name="param_file_name" value="$(arg pre_param_file_name)"/>
      </include>
    </group>
    
    <!-- Global -->
    <group if="$(arg global)">
      <remap from="apriltags_global_node/image_raw" to="apriltags_preprocessing_node/global_image_raw"/>
      <remap from="apriltags_global_node/camera_info" to="camera_node/camera_info"/>
      <include file="$(find apriltags)/launch/apriltags_node.launch">
 	<arg name="veh" value="$(arg veh)"/>
 	<arg name="sub_node_name" value="global"/>
 	<arg name="local" value="$(arg local)"/>
 	<arg name="config" value="$(arg config)"/>
 	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>
    </group>
    
    <!-- Fast -->
    <group if="$(arg fast)">
      <remap from="apriltags_fast_node/image_raw" to="apriltags_preprocessing_node/fast_image_raw"/>
      <remap from="apriltags_fast_node/camera_info" to="camera_node/camera_info"/>      
      <include file="$(find apriltags)/launch/apriltags_node.launch">
 	<arg name="veh" value="$(arg veh)"/>
 	<arg name="sub_node_name" value="fast"/>
 	<arg name="local" value="$(arg local)"/>
 	<arg name="config" value="$(arg config)"/>
 	<arg name="param_file_name" value="$(arg param_file_name)"/>
      </include>

    </group>
    
    
    <group if="$(arg postprocessing)">
      
      
    </group>
  </group>

</launch>
