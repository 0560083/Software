digraph D {
	fontname="sans";
	//rankdir=LR;
	edge [penwidth=1.5]
	node [penwidth=1.5]

	subgraph cluster_legend{
		label="legend"
		// ROS Topics
		//topic_name;
		// ROS Nodes
		node [shape=ellipse,fillcolor=white,style=filled];
		missing [label="missing", fillcolor=red];
		designed [label="designed", fillcolor=pink];
		development [label="development", fillcolor=orange];
		compiled [label="compiled", fillcolor=yellow];
		documented [label="documented", fillcolor=green];
		tested [label="tested", fillcolor=white];
		missing->designed->development->compiled->documented->tested;
	}

	// ==== Nodes Definition ==== //
	node [shape=ellipse,style=filled];
	subgraph node_missing{
		node [fillcolor=red];
		global_localizer[label="global_localizer_node (LC)"];
		intersection_filter[label="intersection_filter (LP)"];
		led_detector[label="led_detector_node (CC)"];
		obj_detector[label="obj_detector_node (CC)"];
		beeper[label="beeper_node (LP)"];
		veh_detector[label="veh_detector_node (CC)"];
		traffic_light_detector[label="traffic_light_detector_node (??)"];
		//coordination_controller[label="coordination_controller (MN?)"];
	}
	subgraph node_designed{
		node [fillcolor=pink];
		mission_planner[label="mission_planner_node (MN)"];
		street_name_detector[label="street_name_detector_node (NW)"];
		safety_supervisor[label="safety_supervisor_node (HA)"];
		map_reader[label="map_reader_node (RM)"];
		veh_coordinator[label="veh_coordinator_node (DH)"]
	}
	subgraph node_development{
		node [fillcolor=orange];
		intersection_controller[label="intersection_control\nopen_loop_intersection_control_node (MN)"];
		stop_line_filter[label="stop_line_filter\nstop_line_filter_node (LP)"];
		rgb_led[label="rgb_led\nrgb_led_driver (DY)"];
	}
	subgraph node_compiled{
		node [fillcolor=yellow];
		wheels_driver[label="dagu_car\nwheels_driver_node (DY,SY)"];
		wheels_cmd_switch[label="dagu_car\nwheels_cmd_switch (SY)"]
		camera_node[label="pi_camera\ncamera_node (SY,AC)"];
		decoder_node[label="pi_camera\ndecoder_node (SY)"];
		cam_info_reader_node[label="pi_camera\ncam_info_reader_node (SY)"];
		lane_controller[label="lane_control\nlane_controller_node (SY,SC)"];
		line_detector[label="line_detector\nline_detector_node (LP,HZ)"];
		april_tag_detector[label="aprialtags\napril_tag_detector (LP)"];
		lane_supervisor[label="lane_control\nlane_supervisor_node (SY)"];
		joy_mapper[label="joy_mapper\njoy_mapper_node (SY)"];
		ground_projection[label="ground_projection\nground_projection_node (CC)"];
		wheels_trimmer[label="dagu_car\nwheels_trimmer_node (SY)"];
		lane_filter[label="lane_filter\nlane_filter_node (LP)"]; 
	}
	subgraph node_documented{
		node [fillcolor=green];
	}
	subgraph node_tested{
		node [fillcolor=white];
		joy_node[label="joy_node"];
		//image_proc;
	}

	// === Files Definition ===
	node [shape=note,style=filled];
	subgraph files{
		motion_calibration_file;
		extrinsic_calibration_file;
		intrinsic_calibration_file;
	}

	{rank=max; wheels_driver;beeper;rgb_led}
	{rank=min; camera_node;joy_node}

	//subgraph node_test {
		//node[shape=box,fillcolor=red];
		//street_name_detector;
		//joy_node;
		//joy_mapper;
	//}

	// ==== Topics ====
	node [shape=box,style=filled,fillcolor=white];
	//{rank=same; mission; joy; map_representation;}
	map_representation[label="~map_representation"];
	segment_list[label="~segment_list"];
	segment_list_proj[label="~segment_list_proj"];
	image_with_lines[label="~image_with_lines"];
	lane_pose[label="~lane_pose"]; //LaneReading: y, phi, sigma_y, sigma_phi, status
	lane_control[label="~lane_control"];
	lane_control_sup[label="~lane_control_supervised"];
	lane_control_safe[label="~lane_control_safe"];
	april_tag_detection[label="~april_tag_detection"];
	led_detection[label="~led_detection"];
	veh_detection[label="~veh_detection"];
	traffic_light_detection[label="~traffic_light_detection"];
	intersection_reading[label="~intersection_reading"];
	obj_detection[label="~obj_detection"];
	global_readings[label="~global_readings"];
	stop_line_reading[label="~stop_line_reading"];
	mode[label="~mode"];
	mission[label="mission"];
	joy_control[label="~joy_control"];
	intersection_control[label="~intersection_control"];
	street_name_detection[label="~street_name_detection"];
	veh_coord_go[label="~veh_coord_go"];
	wheels_command[label="wheels_driver_node/wheels_cmd"];
	wheels_command_switch[label="~wheels_command_switch"];
	camera_info[label="camera_node/camera_info"];
	image_compressed[label="~image/compressed"];

	// ==== Connections ====
	camera_node->image_compressed;
	intrinsic_calibration_file->cam_info_reader_node[style="dotted"];
	image_compressed->cam_info_reader_node;
	cam_info_reader_node->camera_info;
	image_compressed->line_detector;
	image_compressed->led_detector;
	image_compressed->decoder_node;
	decoder_node->image_raw;
	image_compressed->april_tag_detector;
	image_compressed->obj_detector;
	image_compressed->street_name_detector;
	street_name_detector->street_name_detection;
	led_detector->led_detection;
	led_detection->traffic_light_detector;
	segment_list->veh_detector;
	veh_detector->veh_detection;
	traffic_light_detector->traffic_light_detection;
	intersection_filter->intersection_reading;
	line_detector->segment_list 
	line_detector->image_with_lines 
	segment_list_proj->stop_line_filter;
	segment_list_proj->lane_filter;
	lane_filter->lane_pose;
	lane_pose->lane_controller;
	lane_pose->mission_planner;
	stop_line_filter->stop_line_reading;
	stop_line_reading->lane_controller;
	stop_line_reading->mission_planner;
	obj_detector->obj_detection;
	obj_detection->global_localizer;
	street_name_detection->global_localizer;
	april_tag_detector->april_tag_detection;
	april_tag_detection->intersection_filter;
	april_tag_detection->global_localizer;
	global_localizer->global_readings;
	map_reader -> map_representation;
	map_representation->global_localizer;
	map_representation->mission_planner;
	joy_node->joy->joy_mapper->joy_control;
	joy_control-> lane_supervisor;
	lane_controller->lane_control;
	lane_control-> lane_supervisor;
	lane_supervisor-> lane_control_sup;
	lane_control_sup->safety_supervisor;
	safety_supervisor->lane_control_safe;
	safety_supervisor->beeper;
	intersection_reading->mission_planner;
	veh_detection->safety_supervisor;
	intersection_controller->intersection_control;
	global_readings->mission_planner;
	mission_planner->mode;
	mission->mission_planner;
	extrinsic_calibration_file->ground_projection[style="dotted"];
	camera_info->ground_projection;
	segment_list->ground_projection;
	ground_projection->segment_list_proj;
	veh_detection->veh_coordinator;
	traffic_light_detection->veh_coordinator;
	veh_coordinator->veh_coord_go;
	veh_coord_go->mission_planner;
	mode->veh_coordinator;
	mode->lane_controller;
	mode->intersection_controller;
	mode->wheels_cmd_switch;
	wheels_cmd_switch->wheels_command_switch;
	wheels_command_switch->wheels_trimmer;
	motion_calibration_file->wheels_trimmer[style="dotted"]
	wheels_trimmer->wheels_command;
	lane_control_safe->wheels_cmd_switch;
	intersection_control->wheels_cmd_switch;
	wheels_command->wheels_driver;

	//TODO annotate msg type.

	/*
	subgraph cluster_perception{
		label="perception"
		// Nodes
		camera_node;
		decoder_node;
		cam_info_reader_node;
		obj_detector;
		line_detector;
		lane_filter;
		april_tag_detector;
		april_tag_detection;
		led_detector;
		veh_detector;
		stop_line_filter;
		traffic_light_detector;
		intersection_filter;
		street_name_detector;
		ground_projection;

		// Files
		intrinsic_calibration_file;
		extrinsic_calibration_file;

		// Topics
		segment_list[label="~segment_list"];
		segment_list_proj[label="~segment_list_proj"];
		//img_low;
		//img_high;
		april_tag_detection[label="~april_tag_detection"];
		lane_pose;
		image_with_lines;
		obj_detection;
		led_detection;
		veh_detection;
		stop_line_reading;
		traffic_light_detection;
		intersection_reading;
		street_name_detection;
		//img_low_rect;
		//img_high_rect;
		image_compressed[label="~image/compressed"];
		image_raw[label="camera_node/image/raw"];
		camera_info;
		//{rank=same; image_compressed;image_raw;camera_info}
		//{rank=same; extrinsic_calibration_file, ground_projection}
	}

	subgraph cluster_control{
		label="control"
		// Nodes
		joy_node;
		joy_mapper;
		lane_controller;
		intersection_controller;
		//coordination_controller;
		lane_supervisor;
		safety_supervisor;
		wheels_cmd_switch;
		// Topics
		joy_control;
		joy;
		lane_control;
		lane_control_sup;
		lane_control_safe;
		intersection_control;
		wheels_command_switch;
		//coordination_control;
		{rank=same; intersection_controller;lane_controller}
		{rank=same; lane_control_safe;intersection_control}
	}

	subgraph cluster_localization{
		label="localization"
		// Nodes
		map_reader;
		global_localizer;

		// Topics
		map_representation;
		global_readings;
	}

	subgraph cluster_planning{
		label="planning & coordination"
		// Nodes
		mission_planner;
		veh_coordinator;
		// Topics
		veh_coord_go;
		mission;
		mode;
	}

	subgraph cluster_driver{
		label="driver"
		// Nodes
		wheels_trimmer;
		wheels_driver;
		beeper;
		rgb_led;
		{rank=same; wheels_driver, beeper,rgb_led}
		// Files
		motion_calibration_file

		// Topics
		wheels_command;
	}
	*/
}