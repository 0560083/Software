digraph D {
	fontname="sans";
	//rankdir=LR;
	edge [penwidth=1.5]
	node [penwidth=1.5]

	subgraph cluster_legend{
		label="legend"
		// ROS Topics
		//topic_name;
		// ROS Nodes
		node [shape=ellipse,fillcolor=white,style=filled];
		missing [label="missing", fillcolor=red];
		designed [label="designed", fillcolor=pink];
		development [label="development", fillcolor=orange];
		compiled [label="compiled", fillcolor=yellow];
		documented [label="documented", fillcolor=green];
		tested [label="tested", fillcolor=white];
		missing->designed->development->compiled->documented->tested;
	}

	// ==== Nodes Definition ==== //
	node [shape=ellipse,style=filled];
	subgraph node_missing{
		node [fillcolor=red];
		global_localizer[label="global_localizer_node (LC)"];
		//intersection_filter_node[label="intersection_filter_node (LP)"];
		led_detector_node[label="led_detector_node (CC)"];
		obj_detector_node[label="obj_detector_node (CC)"];
		//beeper_driver_node[label="beeper_driver_node (LP)"];
		veh_detector_node[label="veh_detector_node (CC)"];
		traffic_light_detector_node[label="traffic_light_detector_node (??)"];
		lane_supervisor_node[label="lane_control\nlane_supervisor_node (LP)"];
		//coordination_controller[label="coordination_controller (MN?)"];
	}
	subgraph node_designed{
		node [fillcolor=pink];
		street_name_detector_node[label="street_name_detector_node (NW)"];
		safety_supervisor_node[label="safety_supervisor_node (HA)"];
		veh_coordinator_node[label="veh_coordinator_node (DH)"]
		slam_node[label="slam\nslam_node (LC)"];
		navigation_verification_node[label="navigatoin_verificatoin\nnavigation_verification_node (??)"];
	}
	subgraph node_development{
		node [fillcolor=orange];
		open_loop_intersection_control_node[label="intersection_control\nopen_loop_intersection_control_node (MN)"];
		stop_line_filter_node[label="stop_line_filter\nstop_line_filter_node (LP)"];
		rgb_led_driver_node[label="rgb_led_driver\nrgb_led_driver_node (DY)"];
		fsm_node[label="fsm\nfsm_node (MN)"];
		graph_planner_node[label="graph_planner\ngraph_planner_node (??)"];
		mission_planner_node[label="mission_planner\nmission_planner_node (MN)"];
		anti_instagram_node[label="anit_instagram\nanti_instagram_node (F1)"];
		kinematics_learning_node[label="visual_odometry\nkinematics_learning_node (F4)"];
		inverse_kinematics_node[label="forward_kinematics\ninverse_kinematics_node (F4)"];
		forward_kinematics_node[label="forward_kinematics\nforward_kinematics_node (F4)"];

		static_object_detector_node[label="mdoap\nstatic_object_detector_node (F9)"];
		obstacle_safety_node[label="mdoap\nobstacle_safety_node (F9)"];
		simple_stop_controller_node[label="mdoap\nsimple_stop_controller_node (F9)"];
		mdoap_controller_node[label="mdoap\nmdoap_controller_node (F9)"];


	}
	subgraph node_compiled{
		node [fillcolor=yellow];
		wheels_driver_node[label="dagu_car\nwheels_driver_node (DY,SY)"];
		wheels_cmd_switch_node[label="dagu_car\nwheels_cmd_switch (SY)"]
		camera_node[label="pi_camera\ncamera_node (SY,AC)"];
		decoder_node[label="pi_camera\ndecoder_node (SY)"];
		cam_info_reader_node[label="pi_camera\ncam_info_reader_node (SY)"];
		lane_controller_node[label="lane_control\nlane_controller_node (SY,SC)"];
		line_detector_node[label="line_detector\nline_detector_node (LP,HZ)"];
		april_tag_detector[label="aprialtags\napril_tag_detector (LP)"];
		joy_mapper_node[label="joy_mapper\njoy_mapper_node (SY)"];
		ground_projection_node[label="ground_projection\nground_projection_node (CC)"];
		wheels_trimmer[label="dagu_car\nwheels_trimmer_node (SY)"];
		lane_filter_node[label="lane_filter\nlane_filter_node (LP)"]; 
	}
	subgraph node_documented{
		node [fillcolor=green];
	}
	subgraph node_tested{
		node [fillcolor=white];
		joy_node[label="joy_node"];
		//image_proc;
	}

	// === Files Definition ===
	node [shape=note,style=filled];
	subgraph files{
		motion_calibration_file[label="calibration/wheels_trim"];
		extrinsic_calibration_file[label="calibration/camera_extrinsic"];
		intrinsic_calibration_file[label="calibration/camera_intrinsic"];
		navigation_graph_file[label="??/navigation_graph_file"];
		feature_map_file[label="??/feature_map_file"];
		inverse_kinematics_file[label="calibration/inverse_kinematics"];
		kinematics_file[label="calibration/kinematics_param"];
	}



	//subgraph node_test {
		//node[shape=box,fillcolor=red];
		//street_name_detector_node;
		//joy_node;
		//joy_mapper_node;
	//}

	// ==== Topics ====
	node [shape=box,style=filled,fillcolor=white];
	//{rank=same; mission; joy; map_representation;}
	map_representation[label="~map_representation"];
	segment_list[label="~segment_list\nduckietown_msgs/SegmentList.msg"];
	segment_list_proj[label="~segment_list_proj\nduckietown_msgs/SegmentList.msg"];
	image_with_lines[label="~image_with_lines\nsensor_msgs/Image.msg"];
	lane_pose[label="~lane_pose\nduckietown_msgs/LanePose.msg"]; //LaneReading: y, phi, sigma_y, sigma_phi, status
	lane_control[label="~lane_control\nduckietown_msgs/WheelsCmdStamped.msg"];
	lane_control_sup[label="~lane_control_supervised\nduckietown_msgs/WheelsCmdStamped.msg"];
	lane_control_safe[label="~lane_control_safe\nduckietown_msgs/WheelsCmdStamped.msg"];
	april_tag_detection[label="~april_tag_detection\nduckietown_msgs/AprilTags.msg"];
	led_detection[label="~led_detection"];
	veh_detection[label="~veh_detection"];
	traffic_light_detection[label="~traffic_light_detection"];
	//intersection_reading[label="~intersection_reading"];
	obj_detection[label="~obj_detection"];
	global_readings[label="~global_readings"];
	mode[label="~mode\nduckietown_msgs/FSMState.msg"];
	//mission[label="mission"];
	joy_control[label="~joy_control\nduckietown_msgs/WheelsCmdStamped.msg"];
	intersection_control[label="~intersection_control\nduckietown_msgs/WheelsCmdStamped.msg"];
	street_name_detection[label="~street_name_detection\nduckietown_msgs/StreetNameDetection.msg"];
	wheels_command[label="wheels_driver_node/wheels_cmd\nduckietown_msgs/WheelsCmdStamped.msg"];
	wheels_command_switch[label="~wheels_command_switch\nduckietown_msgs/WheelsCmdStamped.msg"];
	camera_info[label="camera_node/camera_info\nsensor_msgs/CameraInfo.msg"];
	image_compressed[label="~image/compressed\nsensor_msgs/CompressedImage.msg"];
	intersection_go[label="~intersection_go\nstd_msgs/Bool.msg"];
	intersection_done[label="~intersection_done\nstd_msgs/Bool.msg"];
	at_stop_line[label="~at_stop_line\nstd_msgs/Bool.msg"];
	in_lane[label="~in_lane\nstd_msgs/Bool.msg"];
	//beep[label="beeper_driver_node/beep"];
	led_cmd[label="rgb_led_driver/led_cmd\nduckietown_msgs/LEDControl.msg"];
	stop_line_dist[label="~stop_line_dist\nstd_msgs/Float32.msg"];
	joy[label="joy\nsensor_msgs/Joy.msg"];

	corrected_image[label="~corrected_image/compressed\nsensor_msgs/CompressedImage.msg"];
	image_health[label="~image_health\nduckietown_msgs/AntiInstagramHealth.msg"];


	forward_kinematics_pose[label="~pose\nduckietown_msgs/Pose2DStamped.msg"];
	forward_kinematics_velocity[label="~velocity\nduckietown_msgs/Twist2DStamped.msg"];
	car_cmd[label="~car_cmd\nduckietown_msgs/Twist2DStamped.msg"]; //No publisher yet


	//F9
	object_image_detection_list[label="~detection_list\nduckietown_msgs/ObjectImageDetectionList.msg"];
	object_too_close[label="~object_too_close\nduckietown_msgs/BoolStamped.msg"];
	object_projected_detection_list[label="~detection_list_proj\nduckietown_msgs/ObjectProjectedDetectionList.msg"];
	object_detection_markers[label="~object_detection_markers\nvisualization_msgs/MarkerArray.msg"];


	{rank=max; wheels_driver_node;rgb_led_driver_node}
	{rank=min; camera_node;joy_node}
	{rank=same;wheels_command;led_cmd}

	// ==== Connections ====
	veh_coordinator_node->intersection_go;
	intersection_go->fsm_node;
	intersection_done->fsm_node;
	at_stop_line->fsm_node;
	in_lane->fsm_node;
	open_loop_intersection_control_node->intersection_done;
	lane_filter_node->in_lane;
	stop_line_filter_node->at_stop_line;
	fsm_node->mode;

	led_cmd->rgb_led_driver_node;
	stop_line_filter_node->stop_line_dist;

	camera_node->image_compressed;
	intrinsic_calibration_file->cam_info_reader_node[style="dotted"];
	image_compressed->cam_info_reader_node;
	cam_info_reader_node->camera_info;
	image_compressed->line_detector_node;
	image_compressed->led_detector_node;
	image_compressed->decoder_node;
	decoder_node->image_raw;
	image_compressed->april_tag_detector;
	image_compressed->obj_detector_node;
	image_compressed->street_name_detector_node;
	street_name_detector_node->street_name_detection;
	led_detector_node->led_detection;
	led_detection->traffic_light_detector_node;
	segment_list->veh_detector_node;
	veh_detector_node->veh_detection;
	traffic_light_detector_node->traffic_light_detection;
	//intersection_filter_node->intersection_reading;
	line_detector_node->segment_list 
	line_detector_node->image_with_lines 
	segment_list_proj->stop_line_filter_node;
	segment_list_proj->lane_filter_node;
	lane_filter_node->lane_pose;
	lane_pose->lane_controller_node;
	//lane_pose->mission_planner;
	//stop_line_filter_node->stop_line_reading;
	//stop_line_reading->lane_controller_node;
	////stop_line_reading->mission_planner;
	obj_detector_node->obj_detection;
	obj_detection->global_localizer;
	street_name_detection->global_localizer;
	april_tag_detector->april_tag_detection;
	//april_tag_detection->intersection_filter_node;
	april_tag_detection->global_localizer;
	global_localizer->global_readings;
	//map_reader_node -> map_representation;
	map_representation->global_localizer;
	//map_representation->mission_planner;
	joy_node->joy->joy_mapper_node->joy_control;
	joy_control-> lane_supervisor_node;
	lane_controller_node->lane_control;
	lane_control-> lane_supervisor_node;
	lane_supervisor_node-> lane_control_sup;
	lane_control_sup->safety_supervisor_node;
	safety_supervisor_node->lane_control_safe;
	//safety_supervisor_node->beeper_driver_node;
	//intersection_reading->mission_planner;
	veh_detection->safety_supervisor_node;
	open_loop_intersection_control_node->intersection_control;
	//global_readings->mission_planner;
	//mission_planner->mode;
	//mission->mission_planner;
	extrinsic_calibration_file->ground_projection_node[style="dotted"];
	camera_info->ground_projection_node;
	segment_list->ground_projection_node;
	ground_projection_node->segment_list_proj;
	veh_detection->veh_coordinator_node;
	traffic_light_detection->veh_coordinator_node;
	//veh_coordinator_node->veh_coord_go;
	////veh_coord_go->mission_planner;
	mode->veh_coordinator_node;
	//mode->lane_controller_node;
	mode->open_loop_intersection_control_node;
	mode->wheels_cmd_switch_node;
	wheels_cmd_switch_node->wheels_command_switch;
	wheels_command_switch->wheels_trimmer;
	motion_calibration_file->wheels_trimmer[style="dotted"]
	wheels_trimmer->wheels_command;
	lane_control_safe->wheels_cmd_switch_node;
	intersection_control->wheels_cmd_switch_node;
	wheels_command->wheels_driver_node;
	//safety_supervisor_node->beep;
	//beep->beeper_driver_node;

	navigation_graph_file->graph_planner_node[style="dotted"];
	slam_node->feature_map_file[style="dotted"];


	// F1
	anti_instagram_node->{corrected_image,image_health};
	image_compressed->anti_instagram_node;

	// F4
	kinematics_learning_node -> {inverse_kinematics_file, kinematics_file}[style=dotted];
	{image_compressed,april_tag_detection,segment_list_proj, car_cmd} -> kinematics_learning_node;

	inverse_kinematics_node -> wheels_command;
	car_cmd -> inverse_kinematics_node;
	inverse_kinematics_file -> inverse_kinematics_node[style="dotted"];

	forward_kinematics_node -> {forward_kinematics_pose,forward_kinematics_velocity};
	kinematics_file -> forward_kinematics_node[style="dotted"];
	wheels_command -> forward_kinematics_node;


	// F9
	image_compressed->static_object_detector_node;
	static_object_detector_node->object_image_detection_list;

	object_image_detection_list -> obstacle_safety_node;
	obstacle_safety_node -> {object_too_close,object_projected_detection_list,object_detection_markers};

	simple_stop_controller_node -> wheels_command;
	{object_projected_detection_list, object_too_close} -> simple_stop_controller_node;
	//TODO: publish to the wheels cmd swtich

	mdoap_controller_node -> wheels_command;
	{object_projected_detection_list, object_too_close} -> mdoap_controller_node;


}